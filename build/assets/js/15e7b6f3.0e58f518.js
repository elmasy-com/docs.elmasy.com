"use strict";(self.webpackChunkwiki_elmasy_com=self.webpackChunkwiki_elmasy_com||[]).push([[122],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>_});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),c=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(o.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,o=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(t),m=r,_=d["".concat(o,".").concat(m)]||d[m]||u[m]||s;return t?a.createElement(_,l(l({ref:n},p),{},{components:t})):a.createElement(_,l({ref:n},p))}));function _(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,l=new Array(s);l[0]=m;var i={};for(var o in n)hasOwnProperty.call(n,o)&&(i[o]=n[o]);i.originalType=e,i[d]="string"==typeof e?e:r,l[1]=i;for(var c=2;c<s;c++)l[c]=t[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},7328:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var a=t(7462),r=(t(7294),t(3905));const s={title:"Nginx",keywords:["nginx"],description:"Nginx is a web server that can also be used as a reverse proxy, load balancer, mail proxy and HTTP cache.",tags:["nginx"]},l="Nginx",i={unversionedId:"guides/nginx",id:"guides/nginx",title:"Nginx",description:"Nginx is a web server that can also be used as a reverse proxy, load balancer, mail proxy and HTTP cache.",source:"@site/docs/guides/nginx.md",sourceDirName:"guides",slug:"/guides/nginx",permalink:"/guides/nginx",draft:!1,editUrl:"https://github.com/elmasy-com/docs.elmasy.com/tree/main/docs/guides/nginx.md",tags:[{label:"nginx",permalink:"/tags/nginx"}],version:"current",frontMatter:{title:"Nginx",keywords:["nginx"],description:"Nginx is a web server that can also be used as a reverse proxy, load balancer, mail proxy and HTTP cache.",tags:["nginx"]},sidebar:"docSidebar",previous:{title:"nftables",permalink:"/guides/nftables"},next:{title:"OpenSSH",permalink:"/guides/ssh"}},o={},c=[{value:"Security configurations",id:"security-configurations",level:2},{value:"TLS",id:"tls",level:3},{value:"Self signed certificate",id:"self-signed-certificate",level:4},{value:"Diffie-Hellman parameters",id:"diffie-hellman-parameters",level:3},{value:"Ciphers",id:"ciphers",level:3},{value:"OpenSSL",id:"openssl",level:4},{value:"Basic authentication",id:"basic-authentication",level:3},{value:"Sample configs",id:"sample-configs",level:2},{value:"nginx.conf",id:"nginxconf",level:3},{value:"sites-available/example.com",id:"sites-availableexamplecom",level:3},{value:"sites-enabled/default",id:"sites-enableddefault",level:3},{value:"conf.d/security.conf",id:"confdsecurityconf",level:3},{value:"Basic reverse proxy template",id:"basic-reverse-proxy-template",level:3},{value:"Useful links",id:"useful-links",level:2}],p={toc:c},d="wrapper";function u(e){let{components:n,...t}=e;return(0,r.kt)(d,(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"nginx"},"Nginx"),(0,r.kt)("h2",{id:"security-configurations"},"Security configurations"),(0,r.kt)("h3",{id:"tls"},"TLS"),(0,r.kt)("p",null,"Get a certificate from Let's Encrypt:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"certbot certonly --nginx -d example.com --rsa-key-size 4096\n")),(0,r.kt)("p",null,"Set TLS ciphers in Nginx ",(0,r.kt)("inlineCode",{parentName:"p"},"server")," context:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\nssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\nssl_trusted_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n")),(0,r.kt)("h4",{id:"self-signed-certificate"},"Self signed certificate"),(0,r.kt)("p",null,"Generate a self-signed certificate for 5 years:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl req -x509 -nodes -newkey rsa:4096 -keyout /etc/nginx/default_ssl/key.pem -out /etc/nginx/default_ssl/cert.pem -days 1825\n")),(0,r.kt)("p",null,"Configure the certificate in ",(0,r.kt)("inlineCode",{parentName:"p"},"server")," context:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ssl_certificate /etc/nginx/default_ssl/cert.pem;\nssl_certificate_key /etc/nginx/default_ssl/key.pem;\n")),(0,r.kt)("h3",{id:"diffie-hellman-parameters"},"Diffie-Hellman parameters"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl dhparam -out /etc/nginx/dhparam.pem 4096\n")),(0,r.kt)("h3",{id:"ciphers"},"Ciphers"),(0,r.kt)("p",null,"List available ciphers:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl ciphers -ciphersuites `openssl ciphers -s -tls1_3`\n")),(0,r.kt)("p",null,"Strongest ciphers"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"TLS_AES_256_GCM_SHA384"),(0,r.kt)("li",{parentName:"ul"},"TLS_CHACHA20_POLY1305_SHA256"),(0,r.kt)("li",{parentName:"ul"},"ECDHE-RSA-AES256-GCM-SHA384"),(0,r.kt)("li",{parentName:"ul"},"ECDHE-RSA-CHACHA20-POLY1305"),(0,r.kt)("li",{parentName:"ul"},"DHE-RSA-AES256-GCM-SHA384"),(0,r.kt)("li",{parentName:"ul"},"DHE-RSA-CHACHA20-POLY1305")),(0,r.kt)("p",null,"Important:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Priority: AES over ChaCha"),(0,r.kt)("li",{parentName:"ul"},"Keysize must be >= 256")),(0,r.kt)("p",null,"Configure TLS ciphers in ",(0,r.kt)("inlineCode",{parentName:"p"},"http")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"server")," context:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ssl_protocols TLSv1.2 TLSv1.3;\nssl_ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305;\nssl_prefer_server_ciphers on;\n")),(0,r.kt)("h4",{id:"openssl"},"OpenSSL"),(0,r.kt)("p",null,"If Nginx version >= 1.19.4:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ssl_conf_command Options ServerPreference;\nssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256;\n")),(0,r.kt)("p",null,"Below Nginx 1.19.4, edit ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/ssl/openssl.cnf"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Options = ServerPreference\nCiphersuites = TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256\n")),(0,r.kt)("h3",{id:"basic-authentication"},"Basic authentication"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"apt install apache2-utils\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"htpasswd -c /etc/nginx/.htpasswd user\n")),(0,r.kt)("p",null,"Use it in a ",(0,r.kt)("inlineCode",{parentName:"p"},"location")," context:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'location /admin {\n        auth_basic "Message";\n        auth_basic_user_file /etc/nginx/.htpasswd;\n}\n')),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"sample-configs"},"Sample configs"),(0,r.kt)("h3",{id:"nginxconf"},"nginx.conf"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"user www-data;\nworker_processes auto;\npid /run/nginx.pid;\ninclude /etc/nginx/modules-enabled/*.conf;\n\nevents {\n        worker_connections 1024;\n}\n\nhttp {\n        # Basic Settings\n        sendfile on;\n        tcp_nopush on;\n        tcp_nodelay on;\n        keepalive_timeout 65;\n        types_hash_max_size 2048;\n\n        include /etc/nginx/mime.types;\n        default_type application/octet-stream;\n\n        # Logging Settings\n        access_log /var/log/nginx/access.log;\n        error_log /var/log/nginx/error.log;\n\n        # Gzip Settings\n        gzip off;\n\n        # Virtual Host Configs\n        include /etc/nginx/conf.d/*.conf;\n        include /etc/nginx/sites-enabled/*;\n}\n")),(0,r.kt)("h3",{id:"sites-availableexamplecom"},"sites-available/example.com"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# https\nserver {\n\n        # Enable SSL and HTTP2\n        listen [::]:443 ssl http2;\n        listen 443 ssl http2;\n\n        server_name example.com;\n\n        # Set certificate path\n        ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n        ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n        ssl_trusted_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n\n        # Enable OCSP\n        ssl_stapling on;\n        ssl_stapling_verify on;\n        resolver 1.1.1.1 1.0.0.1;\n        resolver_timeout 5s;\n\n        # Add security headers\n        add_header X-Frame-Options "SAMEORIGIN" always;\n        add_header X-XSS-Protection "1; mode=block" always;\n        add_header X-Content-Type-Options "nosniff" always;\n        add_header Referrer-Policy \'strict-origin\' always;\n        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains" always;\n\n        # Set root path\n        root /var/www/html;\n        index index.php index.html index.htm;\n\n        location / {\n                try_files $uri $uri/ =404;\n        }\n\n        # Set basic authentication to /admin\n        location /admin {\n                # Basic authentication\n                auth_basic "Message";\n                auth_basic_user_file /etc/nginx/.htpasswd;\n        }\n\n        # Set FastCGI\n        location ~ \\.php$ {\n                include snippets/fastcgi-php.conf;\n                include fastcgi_params;\n                fastcgi_param SCRIPT_FILENAME $document_root/$fastcgi_script_name;\n                fastcgi_pass unix:/var/run/php/php-fpm.sock;\n        }\n\n        # Reverse proxy\n        location /proxy {\n            proxy_set_header   X-Real-IP $remote_addr;\n            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header   Host $host;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_http_version 1.1;\n            proxy_set_header   Upgrade $http_upgrade;\n            proxy_set_header   Connection "upgrade";\n            \n            proxy_ssl_trusted_certificate /etc/nginx/ssl/cert.pem;\n            proxy_ssl_verify       on;\n            proxy_ssl_verify_depth 2;\n            proxy_ssl_session_reuse on;\n            \n            proxy_pass http://127.0.0.1:8080;\n        }\n\n        # Disable accessing hidden files except .well-known\n        location ~ /\\.(?!well-known).* {\n                deny all;\n        }\n\n        # Disable unused methods\n        if ($request_method !~ ^(GET|HEAD|POST)$ ) {\n                return 405;\n        }\n\n        # Custom error pages\n        error_page 404 /404.html;\n        error_page 500 /500.html;\n}\n\n# http\nserver {\n\n        listen 80;\n        listen [::]:80;\n        server_name  example.com;\n\n        # Redirect http to https\n        return 301 https://$host$request_uri;\n}\n')),(0,r.kt)("h3",{id:"sites-enableddefault"},"sites-enabled/default"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n\n    listen [::]:443 ssl http2;\n    listen 443 ssl http2;\n\n    server_name _;\n\n    ssl_certificate /etc/nginx/default_ssl/cert.pem;\n    ssl_certificate_key /etc/nginx/default_ssl/key.pem;\n\n    return 444;\n}\nserver {\n\n    listen 80 default_server;\n    listen [::]:80 default_server;\n    server_name _;\n\n    # Return an empty reply to every other request\n    return 444;\n}\n")),(0,r.kt)("h3",{id:"confdsecurityconf"},"conf.d/security.conf"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Do not send server version\nserver_tokens off;\n\n# Set TLS ciphers\nssl_protocols TLSv1.2 TLSv1.3;\nssl_ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305;\nssl_prefer_server_ciphers on;\n\n# Diffie-Hellman parameters\nssl_dhparam /etc/nginx/dhparam.pem;\nssl_ecdh_curve secp521r1:secp384r1;\n\n# SSL session reuse\nssl_session_cache shared:SSL:10m;\nssl_session_timeout 1d;\nssl_session_tickets off;\n\n# Reduce Time To First Byte\nssl_buffer_size 4k;\n")),(0,r.kt)("h3",{id:"basic-reverse-proxy-template"},"Basic reverse proxy template"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# https\nserver {\n\n        # Enable SSL and HTTP2\n        listen 443 ssl http2;\n\n        server_name example.com;\n\n        # Set certificate path\n        ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n        ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n        ssl_trusted_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n\n        # Enable OCSP\n        ssl_stapling on;\n        ssl_stapling_verify on;\n        resolver 1.1.1.1 1.0.0.1;\n        resolver_timeout 5s;\n\n        # Add security headers\n        add_header X-Frame-Options "SAMEORIGIN" always;\n        add_header X-XSS-Protection "1; mode=block" always;\n        add_header X-Content-Type-Options "nosniff" always;\n        add_header Referrer-Policy \'strict-origin\' always;\n        add_header Strict-Transport-Security "max-age=63072000" always;\n\n        location / {\n                proxy_set_header Host $host;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n                proxy_set_header X-Forwarded-Proto $scheme;\n\n                proxy_pass http://127.0.0.1:8080;\n        }\n}\n\n# http\nserver {\n\n        listen 80;\n        server_name  example.com;\n\n        # Redirect http to https\n        return 301 https://$host$request_uri;\n}\n')),(0,r.kt)("h2",{id:"useful-links"},"Useful links"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.ssllabs.com/ssltest/index.html"},"SSL Test")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://wiki.owasp.org/index.php/OWASP_Secure_Headers_Project"},"OWASP Secure Headers Project")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://securityheaders.com/"},"Security Headers")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://observatory.mozilla.org/"},"Mozilla Observatory")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/yandex/gixy"},"GIXY")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://ssl-config.mozilla.org/"},"SSL Configuration generator"))))}u.isMDXComponent=!0}}]);