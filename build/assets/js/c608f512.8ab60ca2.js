"use strict";(self.webpackChunkwiki_elmasy_com=self.webpackChunkwiki_elmasy_com||[]).push([[578],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>k});var o=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=o.createContext({}),p=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),h=i,k=u["".concat(l,".").concat(h)]||u[h]||c[h]||a;return n?o.createElement(k,r(r({ref:t},d),{},{components:n})):o.createElement(k,r({ref:t},d))}));function k(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,r=new Array(a);r[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:i,r[1]=s;for(var p=2;p<a;p++)r[p]=n[p];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},7003:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>a,metadata:()=>s,toc:()=>p});var o=n(7462),i=(n(7294),n(3905));const a={title:"OpenSSH",keywords:["ssh","linux","security","hardening"],description:"OpenSSH is the premier connectivity tool for remote login with the SSH protocol. It encrypts all traffic to eliminate eavesdropping, connection hijacking, and other attacks. In addition, OpenSSH provides a large suite of secure tunneling capabilities, several authentication methods, and sophisticated configuration options.",tags:["ssh","linux","hardening"]},r="OpenSSH",s={unversionedId:"guides/ssh",id:"guides/ssh",title:"OpenSSH",description:"OpenSSH is the premier connectivity tool for remote login with the SSH protocol. It encrypts all traffic to eliminate eavesdropping, connection hijacking, and other attacks. In addition, OpenSSH provides a large suite of secure tunneling capabilities, several authentication methods, and sophisticated configuration options.",source:"@site/docs/guides/ssh.md",sourceDirName:"guides",slug:"/guides/ssh",permalink:"/guides/ssh",draft:!1,editUrl:"https://github.com/elmasy-com/docs.elmasy.com/tree/main/docs/guides/ssh.md",tags:[{label:"ssh",permalink:"/tags/ssh"},{label:"linux",permalink:"/tags/linux"},{label:"hardening",permalink:"/tags/hardening"}],version:"current",frontMatter:{title:"OpenSSH",keywords:["ssh","linux","security","hardening"],description:"OpenSSH is the premier connectivity tool for remote login with the SSH protocol. It encrypts all traffic to eliminate eavesdropping, connection hijacking, and other attacks. In addition, OpenSSH provides a large suite of secure tunneling capabilities, several authentication methods, and sophisticated configuration options.",tags:["ssh","linux","hardening"]},sidebar:"docSidebar",previous:{title:"nftables",permalink:"/guides/nftables"},next:{title:"Uptime Kuma",permalink:"/guides/uptimekuma"}},l={},p=[{value:"OpenSSH Server",id:"openssh-server",level:2},{value:"The config file",id:"the-config-file",level:3},{value:"Options",id:"options",level:3},{value:"<code>Port</code>",id:"port",level:4},{value:"<code>AddressFamily</code>",id:"addressfamily",level:4},{value:"<code>ListenAddress</code>",id:"listenaddress",level:4},{value:"<code>SyslogFacility</code>",id:"syslogfacility",level:4},{value:"<code>LogLevel</code>",id:"loglevel",level:4},{value:"<code>LoginGraceTime</code>",id:"logingracetime",level:4},{value:"<code>PermitRootLogin</code>",id:"permitrootlogin",level:4},{value:"<code>StrictModes</code>",id:"strictmodes",level:4},{value:"<code>MaxAuthTries</code>",id:"maxauthtries",level:4},{value:"<code>MaxSessions</code>",id:"maxsessions",level:4},{value:"<code>PubkeyAuthentication</code>",id:"pubkeyauthentication",level:4},{value:"<code>AuthorizedKeysFile</code>",id:"authorizedkeysfile",level:4},{value:"<code>HostbasedAuthentication</code>",id:"hostbasedauthentication",level:4},{value:"<code>PasswordAuthentication</code>",id:"passwordauthentication",level:4},{value:"<code>PermitEmptyPasswords</code>",id:"permitemptypasswords",level:4},{value:"<code>ChallengeResponseAuthentication</code>",id:"challengeresponseauthentication",level:4},{value:"<code>KerberosAuthentication</code>",id:"kerberosauthentication",level:4},{value:"<code>GSSAPIAuthentication</code>",id:"gssapiauthentication",level:4},{value:"<code>UsePAM</code>",id:"usepam",level:4},{value:"<code>AllowAgentForwarding</code>",id:"allowagentforwarding",level:4},{value:"<code>AllowTcpForwarding</code>",id:"allowtcpforwarding",level:4},{value:"<code>GatewayPorts</code>",id:"gatewayports",level:4},{value:"<code>X11Forwarding</code>",id:"x11forwarding",level:4},{value:"<code>PrintMotd</code>",id:"printmotd",level:4},{value:"<code>PrintLastLog</code>",id:"printlastlog",level:4},{value:"<code>TCPKeepAlive</code>",id:"tcpkeepalive",level:4},{value:"<code>PermitUserEnvironment</code>",id:"permituserenvironment",level:4},{value:"<code>Compression</code>",id:"compression",level:4},{value:"<code>ClientAliveInterval</code>",id:"clientaliveinterval",level:4},{value:"<code>ClientAliveCountMax</code>",id:"clientalivecountmax",level:4},{value:"<code>UseDNS</code>",id:"usedns",level:4},{value:"<code>PidFile</code>",id:"pidfile",level:4},{value:"<code>MaxStartups</code>",id:"maxstartups",level:4},{value:"<code>PermitTunnel</code>",id:"permittunnel",level:4},{value:"<code>ChrootDirectory</code>",id:"chrootdirectory",level:4},{value:"<code>VersionAddendum</code>",id:"versionaddendum",level:4},{value:"<code>Banner</code>",id:"banner",level:4},{value:"<code>AcceptEnv</code>",id:"acceptenv",level:4},{value:"<code>Subsystem</code>",id:"subsystem",level:4},{value:"<code>AllowUsers</code>",id:"allowusers",level:4},{value:"<code>DenyUsers</code>",id:"denyusers",level:4},{value:"<code>AllowGroups</code>",id:"allowgroups",level:4},{value:"<code>DenyGroups</code>",id:"denygroups",level:4},{value:"Crypto",id:"crypto",level:4},{value:"<code>KexAlgorithms</code>",id:"kexalgorithms",level:5},{value:"<code>HostKey</code>",id:"hostkey",level:5},{value:"<code>Ciphers</code>",id:"ciphers",level:5},{value:"<code>MACs</code>",id:"macs",level:5},{value:"<code>RekeyLimit</code>",id:"rekeylimit",level:5},{value:"Suggestion",id:"suggestion",level:3}],d={toc:p},u="wrapper";function c(e){let{components:t,...n}=e;return(0,i.kt)(u,(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"openssh"},"OpenSSH"),(0,i.kt)("h2",{id:"openssh-server"},"OpenSSH Server"),(0,i.kt)("p",null,"The SSH protocol uses encryption to secure the connection between a client and a server. All user authentication, commands, output, and file transfers are encrypted to protect against attacks in the network. SSH is an Appliaction Layer protocol, uses TCP port 22 by default."),(0,i.kt)("p",null,"Common softwares that uses SSH protocol:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"OpenSSH"),(0,i.kt)("li",{parentName:"ul"},"sftp"),(0,i.kt)("li",{parentName:"ul"},"scp"),(0,i.kt)("li",{parentName:"ul"},"rsync"),(0,i.kt)("li",{parentName:"ul"},"Putty"),(0,i.kt)("li",{parentName:"ul"},"sshfs")),(0,i.kt)("p",null,"What NSA can do with encrypted traffic? Read ",(0,i.kt)("a",{parentName:"p",href:"https://www.spiegel.de/international/germany/inside-the-nsa-s-war-on-internet-security-a-1010361.html"},"here"),".\nThe cryptographic algorithms based on stribika's ",(0,i.kt)("a",{parentName:"p",href:"https://stribika.github.io/2015/01/04/secure-secure-shell.html"},"recommendations"),"."),(0,i.kt)("h3",{id:"the-config-file"},"The config file"),(0,i.kt)("p",null,"OpenSSH reads its configurations from ",(0,i.kt)("em",{parentName:"p"},"/etc/ssh/sshd_config"),"."),(0,i.kt)("p",null,"Before any modification, backup the existing config file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak\n")),(0,i.kt)("p",null,"Lets look into the details..."),(0,i.kt)("p",null,"Open the config file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"sudo nano /etc/ssh/sshd_config\n")),(0,i.kt)("h3",{id:"options"},"Options"),(0,i.kt)("h4",{id:"port"},(0,i.kt)("inlineCode",{parentName:"h4"},"Port")),(0,i.kt)("p",null,"The default port that SSH binds to is 22. Somebody change it to protect himself against bots created by script kiddies (better bots finds the port number anyway).\nIm not going to change it, i leave the protection from bots to fail2ban. To change it, modify 22 to any arbitary number, eg. ",(0,i.kt)("inlineCode",{parentName:"p"},"Port 2222"),". I use the default Port 22."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Port 22\n")),(0,i.kt)("h4",{id:"addressfamily"},(0,i.kt)("inlineCode",{parentName:"h4"},"AddressFamily")),(0,i.kt)("p",null,"Possible options:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"any")," (IPv4 + IPv6)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"inet")," (IPv4)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"inet6")," (IPv6)")),(0,i.kt)("p",null,"Its up to you, i use both IPv4 and IPv6:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"AddressFamily any\n")),(0,i.kt)("h4",{id:"listenaddress"},(0,i.kt)("inlineCode",{parentName:"h4"},"ListenAddress")),(0,i.kt)("p",null,"To bind to localhost on IPv4, use ListenAddress 0.0.0.0.\nTo bind to localhost on IPv6, use ListenAddress ::"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ListenAddress 0.0.0.0\nListenAddress ::\n")),(0,i.kt)("h4",{id:"syslogfacility"},(0,i.kt)("inlineCode",{parentName:"h4"},"SyslogFacility")),(0,i.kt)("p",null,"The default setting is to log to the security/authentication (",(0,i.kt)("inlineCode",{parentName:"p"},"auth"),") facility of ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Syslog"},"syslog"),".\nThis is good, so its not need to be modified.\nThe logs can be found in /var/log/auth.log by default."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"SyslogFacility AUTH\n")),(0,i.kt)("h4",{id:"loglevel"},(0,i.kt)("inlineCode",{parentName:"h4"},"LogLevel")),(0,i.kt)("p",null,"This describes the verbosity of the logs.\nLogging with a ",(0,i.kt)("inlineCode",{parentName:"p"},"DEBUG")," level violates the privacy of users and is not recommended."),(0,i.kt)("p",null,"Options: ",(0,i.kt)("inlineCode",{parentName:"p"},"QUIET"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"FATAL"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"ERROR"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"INFO"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"VERBOSE"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"DEBUG"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"DEBUG1"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"DEBUG2"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"DEBUG3")),(0,i.kt)("p",null,"The default is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"LogLevel INFO\n")),(0,i.kt)("h4",{id:"logingracetime"},(0,i.kt)("inlineCode",{parentName:"h4"},"LoginGraceTime")),(0,i.kt)("p",null,"Time to wait for authentication before disconnection.\nThe default is 2 minutes, to disable this feature use ",(0,i.kt)("inlineCode",{parentName:"p"},"0"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"LoginGraceTime 2m\n")),(0,i.kt)("h4",{id:"permitrootlogin"},(0,i.kt)("inlineCode",{parentName:"h4"},"PermitRootLogin")),(0,i.kt)("p",null,"Do you want to enable root login? I dont think so...\nDisable it!"),(0,i.kt)("p",null,"Use ",(0,i.kt)("inlineCode",{parentName:"p"},"sudo")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"su -")," if you need root."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PermitRootLogin no\n")),(0,i.kt)("h4",{id:"strictmodes"},(0,i.kt)("inlineCode",{parentName:"h4"},"StrictModes")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"sshd")," check file modes and ownership of the user's files and home directory before accepting login. The deault is ",(0,i.kt)("inlineCode",{parentName:"p"},"yes")," because novices sometimes accidentally leave their directory or files world-writable."),(0,i.kt)("h4",{id:"maxauthtries"},(0,i.kt)("inlineCode",{parentName:"h4"},"MaxAuthTries")),(0,i.kt)("p",null,"The number of failed authentication atttempt per connection. Once the number of failures reaches half this value, additional failures are logged.\nThe lower the better, because administrator gets notified earlier and fail2ban reads the log to ban IPs."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"MaxAuthTries 2\n")),(0,i.kt)("h4",{id:"maxsessions"},(0,i.kt)("inlineCode",{parentName:"h4"},"MaxSessions")),(0,i.kt)("p",null,"In SSH, it is allowed to use a session for more than one thing (session multiplexing), this is a not a very useful feature for an average user.\nTo disable it, set it the value to 1."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"MaxSessions 1\n")),(0,i.kt)("h4",{id:"pubkeyauthentication"},(0,i.kt)("inlineCode",{parentName:"h4"},"PubkeyAuthentication")),(0,i.kt)("p",null,"This allows to login with a secure ssh key.\nThe default is yes so no need to modify."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PubkeyAuthentication yes\n")),(0,i.kt)("h4",{id:"authorizedkeysfile"},(0,i.kt)("inlineCode",{parentName:"h4"},"AuthorizedKeysFile")),(0,i.kt)("p",null,"The file SSH search from the authorized keys.\nBy default, this is ",(0,i.kt)("inlineCode",{parentName:"p"},"$HOME/.ssh/authorized_keys"),".\n",(0,i.kt)("inlineCode",{parentName:"p"},"ssh-copy-id")," place your key to this file.\nDont modify!"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"AuthorizedKeysFile     .ssh/authorized_keys\n")),(0,i.kt)("h4",{id:"hostbasedauthentication"},(0,i.kt)("inlineCode",{parentName:"h4"},"HostbasedAuthentication")),(0,i.kt)("p",null,"Enables the remote host to authenticate with his HostKey's public key.\nIt is usefull for automated stuffs.\nDo you need it? Its up to you."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"HostbasedAuthentication no\n")),(0,i.kt)("h4",{id:"passwordauthentication"},(0,i.kt)("inlineCode",{parentName:"h4"},"PasswordAuthentication")),(0,i.kt)("p",null,"Use clear text password (in an encrypted tunnel) to login.\nIf no good password policy applied, your server is vulnerable to brute forcing attack.\nI always use an SSH key so i disable it, i suggest to do it too!"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PasswordAuthentication no\n")),(0,i.kt)("h4",{id:"permitemptypasswords"},(0,i.kt)("inlineCode",{parentName:"h4"},"PermitEmptyPasswords")),(0,i.kt)("p",null,"Do i have to write anything about it?\n",(0,i.kt)("strong",{parentName:"p"},"NEVER")," enable it!\nIt allows to login in without password."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PermitEmptyPasswords no\n")),(0,i.kt)("h4",{id:"challengeresponseauthentication"},(0,i.kt)("inlineCode",{parentName:"h4"},"ChallengeResponseAuthentication")),(0,i.kt)("p",null,"Allows to authenticate via challenge-response.\nIt is possible to setup a 2FA with Google Authenticator for SSH."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ChallengeResponseAuthentication no\n")),(0,i.kt)("h4",{id:"kerberosauthentication"},(0,i.kt)("inlineCode",{parentName:"h4"},"KerberosAuthentication")),(0,i.kt)("p",null,"Do you want to authenticate with Kerberos?"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"KerberosAuthentication no\n")),(0,i.kt)("h4",{id:"gssapiauthentication"},(0,i.kt)("inlineCode",{parentName:"h4"},"GSSAPIAuthentication")),(0,i.kt)("p",null,"Have you ever heard about GSSAPI? No? Then you need the default no."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"GSSAPIAuthentication no\n")),(0,i.kt)("h4",{id:"usepam"},(0,i.kt)("inlineCode",{parentName:"h4"},"UsePAM")),(0,i.kt)("p",null,"PAM (",(0,i.kt)("strong",{parentName:"p"},"P"),"luggable ",(0,i.kt)("strong",{parentName:"p"},"A"),"uthentication ",(0,i.kt)("strong",{parentName:"p"},"M"),"odule) is an authentication framework in Unix. If it is nopt sounds familiar, then disable it.\nI dont use it, so the default no remain unchanged."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"UsePAM no\n")),(0,i.kt)("h4",{id:"allowagentforwarding"},(0,i.kt)("inlineCode",{parentName:"h4"},"AllowAgentForwarding")),(0,i.kt)("p",null,"ssh-agent is used to manage your key. You can forward this ssh-agent to a remote host to use your ssh key on the server. This useful if need to operate with your ssh key on the remote server."),(0,i.kt)("p",null,"Example: authenticate on GitHub with your ssh key, and need to deploy your code on the remote host."),(0,i.kt)("p",null,"Disabling it dont increase security, but if dont use it worth disabling it, unused feature."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"AllowAgentForwarding no\n")),(0,i.kt)("h4",{id:"allowtcpforwarding"},(0,i.kt)("inlineCode",{parentName:"h4"},"AllowTcpForwarding")),(0,i.kt)("p",null,"SSH can be used to forward TCP connections. It can forward local port to the remote host, or vice versa. It is a useful feature in SSH."),(0,i.kt)("p",null,"Disabling it dont increase security."),(0,i.kt)("p",null,"The case is the same as at AllowAgentForwarding, if you dont need it, disable it."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"AllowTcpForwarding no\n")),(0,i.kt)("h4",{id:"gatewayports"},(0,i.kt)("inlineCode",{parentName:"h4"},"GatewayPorts")),(0,i.kt)("p",null,"If you forward a port from remote host to the client, requests only allowed for the server's loopback only by default, so third party cant make a request to the client.\nWith this option, you can enable it."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"GatewayPorts no\n")),(0,i.kt)("h4",{id:"x11forwarding"},(0,i.kt)("inlineCode",{parentName:"h4"},"X11Forwarding")),(0,i.kt)("p",null,"Most Linux distributions enables it by default.\nX11Forwarding allows to use graphical applications on the server.\nMost headless Linux system dont have X at all."),(0,i.kt)("p",null,"Enabling X forwarding ",(0,i.kt)("a",{parentName:"p",href:"https://security.stackexchange.com/questions/14815/security-concerns-with-x11-forwarding/14817#14817"},"considered")," harmfull."),(0,i.kt)("p",null,"Disable it!"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"X11Forwarding no\n")),(0,i.kt)("h4",{id:"printmotd"},(0,i.kt)("inlineCode",{parentName:"h4"},"PrintMotd")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"M"),"essage ",(0,i.kt)("strong",{parentName:"p"},"o"),"f ",(0,i.kt)("strong",{parentName:"p"},"t"),"he ",(0,i.kt)("strong",{parentName:"p"},"d"),"ay can be fun and useful if you create one. Ubuntu has a package (",(0,i.kt)("inlineCode",{parentName:"p"},"update-motd"),") to generate dynamic messages.\nThats it.\nThis is shown ",(0,i.kt)("strong",{parentName:"p"},"after")," successfull authentication. The banner before authentication is ",(0,i.kt)("inlineCode",{parentName:"p"},"Banner")," below."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PrintMotd no\n")),(0,i.kt)("h4",{id:"printlastlog"},(0,i.kt)("inlineCode",{parentName:"h4"},"PrintLastLog")),(0,i.kt)("p",null,"Do you want to print the last login's details?"),(0,i.kt)("p",null,"It look like this:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Last login: Fri Dec  6 22:45:44 2019 from [IP]")),(0,i.kt)("p",null,"It can be useful if you are the only user in the server."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PrintLastLog yes\n")),(0,i.kt)("h4",{id:"tcpkeepalive"},(0,i.kt)("inlineCode",{parentName:"h4"},"TCPKeepAlive")),(0,i.kt)("p",null,'Send TCP keep alive to the other side of the connection. It is usefull to properly handle the crash of the other side (eg. network problems, system crash) and kill connection to avoid "ghost" users.'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"TCPKeepAlive yes\n")),(0,i.kt)("h4",{id:"permituserenvironment"},(0,i.kt)("inlineCode",{parentName:"h4"},"PermitUserEnvironment")),(0,i.kt)("p",null,"Allows user to set their environment. It can be a security risk if your are managing what a user can do. With an interactive shell, the security risk is zero."),(0,i.kt)("p",null,"If you are using ",(0,i.kt)("inlineCode",{parentName:"p"},"~/.ssh/environment")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"environment=")," options in ~/.ssh/authorized_keys, enable it."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PermitUserEnvironment no\n")),(0,i.kt)("h4",{id:"compression"},(0,i.kt)("inlineCode",{parentName:"h4"},"Compression")),(0,i.kt)("p",null,"Compression can speed up your connection.\nIf your internet connection is slow (eg. using SSH over Tor) enable it."),(0,i.kt)("p",null,"Possible options:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"no"),": no compression"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"delayed"),": compresion after successful authentication, this is the default"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"yes"),": compress everything")),(0,i.kt)("p",null,"Your choice!"),(0,i.kt)("p",null,"I select not to compress:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Compression no\n")),(0,i.kt)("h4",{id:"clientaliveinterval"},(0,i.kt)("inlineCode",{parentName:"h4"},"ClientAliveInterval")),(0,i.kt)("p",null,"Time to wait in second before sending a null packet on an idle ssh session.\nThis option is different from TCPKeepAlive. The ClientAliveInterval sends the data in an encrypted tunnel (so not spoofable), while TCPKeepAlive is sent unencrypted (spoofable).\nIdle connection ",(0,i.kt)("strong",{parentName:"p"},"can")," be a security problem (eg. client gets comporomised while the connection is open)."),(0,i.kt)("p",null,"First part of disabling idle connection is to set this option to a specific time, eg. 10 minutes:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ClientAliveInterval 600\n")),(0,i.kt)("h4",{id:"clientalivecountmax"},(0,i.kt)("inlineCode",{parentName:"h4"},"ClientAliveCountMax")),(0,i.kt)("p",null,"This sets the number of keep alive packets sent by SSH (not TCPKeepAlive). If the threshold is reached, the SSH server disconnect the client."),(0,i.kt)("p",null,"This is second (and last) part to disable the idle sessions.\nTo disconnect the client after 30 minute of idling, set it to 3 (3x600 sec):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ClientAliveCountMax 3\n")),(0,i.kt)("h4",{id:"usedns"},(0,i.kt)("inlineCode",{parentName:"h4"},"UseDNS")),(0,i.kt)("p",null,"Do a reverse DNS lookup on the remote IP. This setting is useless because of high chance that the IP dont have reverse DNS setted. Second, it could cause to hang the connection if the DNS server not respond for any reason."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"UseDNS no\n")),(0,i.kt)("h4",{id:"pidfile"},(0,i.kt)("inlineCode",{parentName:"h4"},"PidFile")),(0,i.kt)("p",null,"Pid (process is) file is a simple text file. Programs write the main pid's in it to use it later (eg. kill itself).\nIf you want to specify the SSH's pid file's location, modify it, else leave it the default setting:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PidFile /var/run/sshd.pid\n")),(0,i.kt)("h4",{id:"maxstartups"},(0,i.kt)("inlineCode",{parentName:"h4"},"MaxStartups")),(0,i.kt)("p",null,"Specify the number of allowed unaunthenticated connections.\nThe default is 10, its ok."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"MaxStartups 10\n")),(0,i.kt)("h4",{id:"permittunnel"},(0,i.kt)("inlineCode",{parentName:"h4"},"PermitTunnel")),(0,i.kt)("p",null,"Do you want to use your ssh server as a proxy?"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PermitTunnel no\n")),(0,i.kt)("h4",{id:"chrootdirectory"},(0,i.kt)("inlineCode",{parentName:"h4"},"ChrootDirectory")),(0,i.kt)("p",null,"chroot is special to Unix systems. Its modifys the current root director (/). If you want to restrict what user can do on your server set it, a good explanation can be found ",(0,i.kt)("a",{parentName:"p",href:"https://www.tecmint.com/restrict-ssh-user-to-directory-using-chrooted-jail/"},"here"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ChrootDirectory none\n")),(0,i.kt)("h4",{id:"versionaddendum"},(0,i.kt)("inlineCode",{parentName:"h4"},"VersionAddendum")),(0,i.kt)("p",null,"Append text to the SSH protocol banner sent by the server uppon connection."),(0,i.kt)("p",null,"This is not the login banner below, it is the text that you see when using Nmap with service scan."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"VersionAddendum none\n")),(0,i.kt)("h4",{id:"banner"},(0,i.kt)("inlineCode",{parentName:"h4"},"Banner")),(0,i.kt)("p",null,"Banner shows the message before authentication, It reads its content from a file."),(0,i.kt)("p",null,"This is just a fun factor, so i disabled it:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Banner none\n")),(0,i.kt)("h4",{id:"acceptenv"},(0,i.kt)("inlineCode",{parentName:"h4"},"AcceptEnv")),(0,i.kt)("p",null,"The client can send theit local environment variables to the server.\nThis options specifies what environment variables are accepted."),(0,i.kt)("p",null,"The default is not accept anything, but on Debian the default is to accept LANG and LC_*."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"AcceptEnv LANG LC_*\n")),(0,i.kt)("h4",{id:"subsystem"},(0,i.kt)("inlineCode",{parentName:"h4"},"Subsystem")),(0,i.kt)("p",null,"Subsystem is a useful feature of SSH, it is a set of remote command predefined on the server. Read more ",(0,i.kt)("a",{parentName:"p",href:"https://docstore.mik.ua/orelly/networking_2ndEd/ssh/ch05_07.htm"},"here")," if you are interested."),(0,i.kt)("p",null,"By default, sftp is configured:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Subsystem       sftp    /usr/lib/openssh/sftp-server\n")),(0,i.kt)("h4",{id:"allowusers"},(0,i.kt)("inlineCode",{parentName:"h4"},"AllowUsers")),(0,i.kt)("p",null,"This creates a whitelist of users that is allowed to log in.\nAny other user is disabled. The users are space separated list."),(0,i.kt)("p",null,"It is useful if you dont have much users to manage on your server."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"AllowUsers user\n")),(0,i.kt)("p",null,"There are more option to manage users. It will be explained below."),(0,i.kt)("p",null,"The order of parsing this rules are this, started from the top:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"DenyUsers")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"AllowUsers")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"DenyGroups")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"AllowGroups"))),(0,i.kt)("h4",{id:"denyusers"},(0,i.kt)("inlineCode",{parentName:"h4"},"DenyUsers")),(0,i.kt)("p",null,"This creates a blacklist of users that cant log in.\nAny other users that not on the list can log in.\nThe list of users is a space separated list."),(0,i.kt)("h4",{id:"allowgroups"},(0,i.kt)("inlineCode",{parentName:"h4"},"AllowGroups")),(0,i.kt)("p",null,"This option allows user groups to log in.\nOnly users of this group can login."),(0,i.kt)("p",null,"This option is useful if you need to manage large number of users."),(0,i.kt)("p",null,"If you want to use this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"# create a group\ngroupadd ssh-login\n\n# Add the user to the group\nusermod -aG ssh-login example\n\n# configure sshd:\n...\nAllowGroups ssh-login\n...\n")),(0,i.kt)("h4",{id:"denygroups"},(0,i.kt)("inlineCode",{parentName:"h4"},"DenyGroups")),(0,i.kt)("p",null,"The groups specified in this option cant login. This is the opposite of AllowGroups."),(0,i.kt)("h4",{id:"crypto"},"Crypto"),(0,i.kt)("h5",{id:"kexalgorithms"},(0,i.kt)("inlineCode",{parentName:"h5"},"KexAlgorithms")),(0,i.kt)("p",null,"Key exchange algorithm is used to exchange secret between the server and the client, so it should be secure."),(0,i.kt)("p",null,"There a ",(0,i.kt)("a",{parentName:"p",href:"https://tools.ietf.org/id/draft-ietf-curdle-ssh-kex-sha2-09.html#rfc.section.3.1"},"list")," of methods to key exchange, worth reading it. I use the two largest Diffie-Helman algorithms. It may be slower than others!"),(0,i.kt)("p",null,"If you need to use a faster algorithm, use ",(0,i.kt)("inlineCode",{parentName:"p"},"curve25519-sha256@libssh.org"),"."),(0,i.kt)("p",null,"I use the two strongest:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"KexAlgorithms diffie-hellman-group18-sha512,diffie-hellman-group16-sha512\n")),(0,i.kt)("h5",{id:"hostkey"},(0,i.kt)("inlineCode",{parentName:"h5"},"HostKey")),(0,i.kt)("p",null,"Host key is used to authenticate the server to the client. It should be unique to prevent network based attack (eg. mitm)."),(0,i.kt)("p",null,"Stribika suggests not to use DSA/ECDSA because it is depends on random numbers and DSA's key lenght is only 1024 bits. He is right, so i disable it."),(0,i.kt)("p",null,"The final config looks like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"HostKey /etc/ssh/ssh_host_rsa_key\nHostKey /etc/ssh/ssh_host_ed25519_key\n")),(0,i.kt)("p",null,"Don't forget to generate larger host keys after the configuration:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'cd /etc/ssh\nrm ssh_host_*key*\nssh-keygen -t ed25519 -f ssh_host_ed25519_key -N "" < /dev/null\nssh-keygen -t rsa -b 4096 -f ssh_host_rsa_key -N "" < /dev/null\n')),(0,i.kt)("p",null,"On a new connection, you should see this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\n...\n")),(0,i.kt)("p",null,"Remove the known hosts file and it should be fine:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"rm $HOME/.ssh/known_hosts\n")),(0,i.kt)("h5",{id:"ciphers"},(0,i.kt)("inlineCode",{parentName:"h5"},"Ciphers")),(0,i.kt)("p",null,"Ciphers is used to encrypt the data between the client and the server.\nIt is use a symmetric encryption. The bigger the better."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ChaCha20")," is stream cipher, while AES is a block cipher."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ChaCha20")," is the preferred encryption method is SSH and the de facto standard for stream ciphers, replacing the old and broken RC4."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Ciphers chacha20-poly1305@openssh.com\n")),(0,i.kt)("h5",{id:"macs"},(0,i.kt)("inlineCode",{parentName:"h5"},"MACs")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"M"),"essage ",(0,i.kt)("strong",{parentName:"p"},"A"),"authentication ",(0,i.kt)("strong",{parentName:"p"},"C"),"ode provides integrity.\nBecause i use ",(0,i.kt)("inlineCode",{parentName:"p"},"chacha20-poly1305@openssh.com")," for cipher, the MAC is ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Poly1305"},"poly1305"),"."),(0,i.kt)("p",null,"Anyway, i set the strongest MAC to disable the weaks."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"MACs hmac-sha2-512-etm@openssh.com\n")),(0,i.kt)("h5",{id:"rekeylimit"},(0,i.kt)("inlineCode",{parentName:"h5"},"RekeyLimit")),(0,i.kt)("p",null,"Changing the session key over time to mitigate crypt analysis attacks.\nOne method to attack cryptography is to collect a huge ammount of data to analyse and restore the key."),(0,i.kt)("p",null,"Changing key too often not suggested."),(0,i.kt)("p",null,"My options is after 1 gigabyte or 1 hour:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"RekeyLimit 1G 1h       \n")),(0,i.kt)("h3",{id:"suggestion"},"Suggestion"),(0,i.kt)("admonition",{type:"danger"},(0,i.kt)("p",{parentName:"admonition"},"Dont forget to change the value for ",(0,i.kt)("inlineCode",{parentName:"p"},"AllowUsers"),"!")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# IP\nPort 22\nAddressFamily any\nListenAddress 0.0.0.0\nListenAddress ::\n\n# logging\nSyslogFacility AUTH\nLogLevel INFO\n\n# authentication\nLoginGraceTime 2m\nPermitRootLogin no\nStrictModes yes\nMaxAuthTries 2\nMaxSessions 1\nPubkeyAuthentication yes\nAuthorizedKeysFile      .ssh/authorized_keys\nHostbasedAuthentication no\nPasswordAuthentication no\nChallengeResponseAuthentication no\nKerberosAuthentication no\nGSSAPIAuthentication no\nUsePAM no\n\n# misc\nAllowAgentForwarding no\nAllowTcpForwarding yes\nGatewayPorts no\nX11Forwarding no\nPrintMotd no\nPrintLastLog yes\nTCPKeepAlive yes\nPermitUserEnvironment no\nCompression no\nClientAliveInterval 600\nClientAliveCountMax 3\nUseDNS no\nPidFile /var/run/sshd.pid\nMaxStartups 10\nPermitTunnel no\nChrootDirectory none\nVersionAddendum none\nBanner none\nAcceptEnv LANG LC_*\nSubsystem       sftp    /usr/lib/openssh/sftp-server\n\n# users\nAllowUsers CHANGEME\n\n# crypto\nKexAlgorithms diffie-hellman-group18-sha512,diffie-hellman-group16-sha512\nHostKey /etc/ssh/ssh_host_ed25519_key\nHostKey /etc/ssh/ssh_host_rsa_key\nCiphers chacha20-poly1305@openssh.com\nMACs hmac-sha2-512-etm@openssh.com\nRekeyLimit 1G 1h\n")))}c.isMDXComponent=!0}}]);